name: Auto Sync master → staging

on:
  pull_request:
    types: [closed]
    branches:
      - master
  push:
    branches:
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  sync-staging:
    # Run only when:
    # - A PR into master was merged AND the source branch is NOT "staging"
    #   (prevents infinite loops when releasing staging → master)
    # - OR when there is a direct push to master (e.g. a hotfix)
    if: >
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.head.ref != 'staging')
      ||
      (github.event_name == 'push')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history is required so the action can create/update PRs properly
          fetch-depth: 0
          # Fetch both master and staging branches
          ref: master

      - name: Fetch staging branch
        run: |
          git fetch origin staging:staging

      - name: Create or update PR from master → staging
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Try to create PR, if it already exists it will just show the existing one
          set +e
          pr_url=$(gh pr create \
            --base staging \
            --head master \
            --title "Sync master → staging" \
            --body "Automated pull request to sync **master → staging**.

          This PR was created by GitHub Actions after changes were merged into master.

          **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" 2>&1)

          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "PR created successfully: $pr_url"
          else
            # Check if error is because PR already exists
            if echo "$pr_url" | grep -q "already exists"; then
              echo "PR already exists. It will be automatically updated when you push to master."
              # Get the existing PR URL
              existing_pr=$(gh pr list --base staging --head master --state open --json url --jq '.[0].url')
              echo "Existing PR: $existing_pr"
            else
              echo "Error creating PR: $pr_url"
              exit 1
            fi
          fi
