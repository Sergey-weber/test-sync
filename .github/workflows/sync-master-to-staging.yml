name: Auto Sync master → staging

on:
  pull_request:
    types: [closed]
    branches:
      - master
  push:
    branches:
      - master

jobs:
  sync-staging:
    # Run only when:
    # - A PR into master was merged AND the source branch is NOT "staging"
    #   (prevents infinite loops when releasing staging → master)
    # - OR when there is a direct push to master (e.g. a hotfix)
    if: >
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.head.ref != 'staging')
      ||
      (github.event_name == 'push')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history is required so the action can create/update PRs properly
          fetch-depth: 0
          # Fetch both master and staging branches
          ref: master

      - name: Fetch staging branch
        run: |
          git fetch origin staging:staging

      - name: Create or update PR from master → staging
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if a PR from master to staging already exists
          existing_pr=$(gh pr list --base staging --head master --state open --json number --jq '.[0].number')

          if [ -n "$existing_pr" ]; then
            echo "Found existing PR #$existing_pr, updating it..."
            # Update PR description to show it was updated
            gh pr edit "$existing_pr" --body "Automated pull request to sync **master → staging**.

          This PR was created by GitHub Actions after changes were merged into master.

          **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "PR #$existing_pr has been updated"
          else
            echo "No existing PR found, creating a new one..."
            # Create new PR
            gh pr create \
              --base staging \
              --head master \
              --title "Sync master → staging" \
              --body "Automated pull request to sync **master → staging**.

          This PR was created by GitHub Actions after changes were merged into master.

          **Created:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
              --label "auto-sync"
            echo "New PR has been created"
          fi
